# common-headers.conf — included in every location block
#
# nginx's add_header does NOT inherit from parent blocks when a child
# block defines ANY add_header of its own.  This snippet is the single
# source of truth for security + CORS headers; including it in each
# location block sidesteps the inheritance trap entirely.

# ── CORS preflight ───────────────────────────────────────────────────
# Browsers send an OPTIONS request before any cross-origin fetch().
# Using `if` with `return` is one of nginx's documented safe patterns.
if ($request_method = OPTIONS) {
    add_header Access-Control-Allow-Origin  "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;
    add_header Access-Control-Max-Age       86400 always;
    add_header Content-Length               0 always;
    add_header Content-Type                 "text/plain" always;
    return 204;
}

# ── Security headers ─────────────────────────────────────────────────
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
add_header X-Content-Type-Options    "nosniff" always;
add_header X-Frame-Options           "SAMEORIGIN" always;
add_header X-XSS-Protection          "1; mode=block" always;
add_header Referrer-Policy            "no-referrer-when-downgrade" always;
add_header Permissions-Policy         "camera=(), microphone=(), geolocation=(), payment=()" always;

# ── CORS response headers ────────────────────────────────────────────
# For normal (non-preflight) requests — allows cross-origin reads of
# public static assets (Storybook composition, Docusaurus search, etc.)
add_header Access-Control-Allow-Origin  "*" always;
add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
add_header Access-Control-Allow-Headers "Origin, Content-Type, Accept" always;
